<script src="https://koda.nu/simple.js">

  // Map array
  const mapArray = [[0,5,"grass"],[1,5,"grass"],[2,4,"grass"],[3,5,"grass"],[4,5,"grass"]];
  const blockSize = 63.1;
  
  // Scaling (10 blocks tall)
  const scale_factor = blockSize * 10 / totalHeight;
  scale(1 / scale_factor,1 / scale_factor);
  
  // Assets
  const bricksUrl = "https://cdn.discordapp.com/attachments/489085929726935041/616212100481679368/block.png";
  const grassUrl = "https://cdn.discordapp.com/attachments/489085929726935041/616702235484618754/flatgrass.png";
  const mario1Url = "https://cdn.discordapp.com/attachments/489085929726935041/616713067551784964/mario1.png";

  // Global variables
  const gravity = 1
  
  class Player {
    constructor(respawnX, respawnY) {
      this.x = respawnX;
      this.y = respawnY;
      this.xv = 0;
      this.yv = 0;
      this.touching_ground = false;
      this.state = 1;
    }
    
    // Function that checks if any block is within range to collide
    checkCollision() {
      // Set char to be in the air so if it isn't on the ground he can't air jump
      this.touching_ground = false;

      // For every block
      for (var i = 0; i < mapArray.length; i++) {
        // If in range
        if (abs(this.x / blockSize - mapArray[i][0]) < 3 && abs(this.y / blockSize - mapArray[i][1]) < 3) {
          //Perform collision
        	this.performCollision(mapArray[i][0] * blockSize, totalHeight - blockSize * mapArray[i][1]);
        }
      }
    }
    
    // Performs collision by detecting what side of the block was impacted and adjusting the character velocity
    performCollision(blockX,blockY) {
      // Calculate delta in coming tick
      var dx_next = abs(this.x + this.xv - blockX);
      var dy_next = abs(this.y + this.yv - blockY);
      
      // Calculate pos in coming tick
      var x_next = this.x - blockX;
      var y_next = this.y - blockY;
      
      // Calculate delta in current tick
      var dx = abs(this.x - blockX);
      var dy = abs(this.y - blockY);
      
      // If not going to collide, don't perform calculation
      if (dy_next > blockSize && dx_next > blockSize) {
        return null
      }
      console.log("collided")

      if (y_next + blockSize > blockY && this.y < y_next) {
          
        // Top
        this.yv = blockSize-dy;
        this.touching_ground = true;
          
      }else if (y_next < blockY + blockSize && this.y > y_next && y_next > blockY) {
          
        // Bottom
        this.yv = dy-blockSize;
          
      }else if (x_next + blockSize > blockX && this.x < x_next) {
          
        // Left
        this.xv = -dx+blockSize;
            
      }else if (x_next < blockX + blockSize && this.x > x_next) {
          
        // Right
        this.xv = dx-blockSize;
          
      }
    }

    render() {
      var url;

      if (this.state == 1) {
        url = mario1Url;
      }
      picture(this.x,this.y,url);
    }

    apply_forces() {
      if (! this.touching_ground) {
        this.yv += gravity
      }
    }

    update_position() {
      this.x += this.xv
      this.y += this.yv
    }
  }
  
  
  
  
  
  function drawMap() {
  	// Go through every block
    for (var i = 0; i < mapArray.length; i++) {
      var url;
      if (mapArray[i][2] == "grass") {
        url = grassUrl      
      }else if (mapArray[i][2] == "bricks") {
        url = bricksUrl
      }
      picture(mapArray[i][0] * blockSize, blockSize * mapArray[i][1],url);
    }
  }
  
  let player1 = new Player(0,0);

  function update() {
  	clearScreen();
    drawMap();
    player1.apply_forces();
    player1.checkCollision();
    player1.update_position();
    player1.render();
  }
  

</script>